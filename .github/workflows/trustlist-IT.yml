name: Renew Trustlist IT

on:
  schedule:
    - cron: '0 5,10,15,20 * * *'
  push:
    branches: ['main']

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./scripts/trustlist_it/
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '14'
      - name: prepare node  
        run: npm install
      - name: get script from source
        run: curl -o "./fetch_certificates.js.new" -z "./fetch_certificates.js" "https://raw.githubusercontent.com/ministero-salute/dcc-utils/master/examples/fetch_certificates.js"
      - name: patch script output path
        run: output_path="../../trustlist_it.json"; patch="const OUTFILE = '$output_path';"; sed -i "/^\/\//! {/const OUTFILE =/{s|^|\/\/|;s|$|\n$patch|}}" fetch_certificates.js.new && mv fetch_certificates.js.new fetch_certificates.js
      - name: get trustlist IT
        run: node fetch_certificates.js
      - name: minify json
        run: python ../minify.py ../../trustlist_it.json
      - uses: EndBug/add-and-commit@v7
        with:
          author_name: github action download trustlist
          message: 'Update Trustlist IT'
          add: "['trustlist_it.json', 'trustlist_it.min.json', '*.js']"
